<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Level 2 ‚Äì Game HTML: Form & Tabel</title>
    <link rel="stylesheet" href="../css/level1html.css" />
    <style>
      .pill {
        display: inline-block;
        padding: 6px 10px;
        margin: 4px;
        border-radius: 6px;
        background: #e2e8f0;
        font-weight: bold;
        user-select: none;
      }
      .pill.done {
        background: #22c55e;
        color: white;
      }
      .pill.active {
        background: #3b82f6;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="custom-navbar fixed-top">
      <div class="navbar-container">
        <a href="../../index.php" class="logo">
          <img src="../img/KiddosLogo.png" alt="Logo" />
        </a>
        <div class="nav-right">
          <div class="chatbot">
            <a href="Kiddos AI.html"
              ><img src="../img/boticons.png" alt="Chatbot"
            /></a>
          </div>
          <div class="hamburger" id="hamburger">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>
    </nav>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
      <a href="../../index.php"
        ><img src="../img/homeicons.png" class="menu-icon" />Home</a
      >
      <a href="../../index.php #Materi"
        ><img src="../img/brainicons.png" class="menu-icon2" />Learn</a
      >
      <a href="../../index.php #Games"
        ><img src="../img/gameicons.png" class="menu-icon3" />Games</a
      >
      <a href="profile.php"
        ><img src="../img/profileicons.png" class="menu-icon" />Profile</a
      >
    </div>

    <canvas id="starsCanvas"></canvas>
    <div class="page-wrapper">
      <div class="shell">
        <header>
          <h1>Level 2 ‚Äî Form & Tabel HTML</h1>
          <div class="sub">
            Drag & drop potongan tag ke slot kosong. Selesaikan seluruh level
            untuk dapet badge <b>HTML GG</b>.
          </div>
          <div class="progress"><div id="bar" class="bar"></div></div>
          <button id="resetBtn" class="reset-btn">Reset Progress</button>
          <button
            id="btnPrev"
            class="ghost"
            style="
              position: relative;
              top: 2.8px;
              height: 2.25rem;
              margin-left: 5px;
            "
          >
            <span style="position: relative; top: -2px">‚¨ÖÔ∏è Kembali</span>
          </button>
        </header>

        <!-- LEFT: GAME -->
        <section class="card">
          <div id="qTitle" class="sub" style="font-weight: 700">
            Tantangan 1/8
          </div>
          <div
            id="instruksiBox"
            class="sub"
            style="font-weight: 600; color: #ffffff"
          ></div>
          <div class="prompt"><code id="preview"></code></div>
          <div class="slots" id="slots"></div>
          <div>
            <div style="font-weight: 700; margin-bottom: 6px; color: white">
              Bank Tag:
            </div>
            <div id="bank" class="bank"></div>
          </div>
          <div class="actions">
            <button id="btnCheck" class="primary">Cek Jawaban</button>
            <button id="btnReset" class="ghost">Reset Susunan</button>
            <span id="feedback" class="msg hidden"></span>
          </div>
        </section>

        <!-- RIGHT: SIDEBAR -->
        <aside class="side">
          <div class="stat">
            <h3>Progress Soal</h3>
            <div id="pillWrap" class="list"></div>
          </div>
          <div class="stat">
            <h3>Aturan Main</h3>
            <ul
              style="
                margin: 0.2rem 0 0.2rem 1rem;
                color: #334155;
                line-height: 1.6;
              "
            >
              <li>Drag potongan tag ke slot kosong.</li>
              <li>Tekan <b>Cek Jawaban</b> untuk menilai.</li>
              <li>Benar = lanjut otomatis ke soal berikutnya.</li>
              <li>Semua level selesai = dapat badge üéñÔ∏è.</li>
            </ul>
          </div>
          <div id="badgeBox" class="badge hidden">
            <div class="icon">üèÖ</div>
            <div>
              <div style="font-weight: 800">Badge!</div>
              <div>HTML GG ‚Äî Selesaikan semua level HTML.</div>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Popup Next Level -->
    <div id="nextLevelPopup" class="popup-overlay" style="display: none">
      <div class="popup-card">
        <h2>üéâ Level Selesai!</h2>
        <p>Keren banget, kamu udah nyelesaiin semua soal di level ini.</p>
        <button id="nextBtn">‚û°Ô∏è Lanjut ke Level Berikutnya</button>
      </div>
    </div>

    <script>
      // ======= DATA SOAL LEVEL 2 (versi fix) =======
      const QUIZ = [
        {
          instruksi: "Buat baris tabel dengan data dua kolom.",
          preview: `&lt;table&gt; &lt;tr&gt; &lt;?&gt; Nama &lt;?&gt; &lt;?&gt; Umur &lt;?&gt;`,
          slots: ["<td>", "</td>", "<td>", "</td>"],
          bank: ["<td>", "</td>", "<td>", "</td>", "<th>", "</th>"],
        },
        {
          instruksi: "Kasih header tabel untuk judul kolom.",
          preview: `&lt;tr&gt; &lt;?&gt; Nama &lt;?&gt; &lt;?&gt; Umur &lt;?&gt;`,
          slots: ["<th>", "</th>", "<th>", "</th>"],
          bank: ["<th>", "</th>", "<td>", "</td>"],
        },
        {
          instruksi: "Bikin input teks dalam form.",
          preview: `&lt;form&gt; &lt;? type="text" name="user" ?&gt; &lt;/form&gt;`,
          slots: ["<input", ">"],
          bank: ["<input", ">", "<button>", "<textarea>"],
        },
        {
          instruksi: "Buat tombol submit di form.",
          preview: `&lt;form&gt; &lt;?&gt;Kirim&lt;?&gt; &lt;/form&gt;`,
          slots: ["<button type='submit'>", "</button>"],
          bank: ["<button type='submit'>", "</button>"],
        },
        {
          instruksi: "Bungkus item daftar terurut.",
          preview: `&lt;ol&gt; &lt;?&gt; Item 1 &lt;?&gt; &lt;?&gt; Item 2 &lt;?&gt; &lt;/ol&gt;`,
          slots: ["<li>", "</li>", "<li>", "</li>"],
          bank: ["<li>", "</li>", "<ul>", "</ul>"],
        },
        {
          instruksi: "Tambahkan caption pada tabel.",
          preview: `&lt;table&gt; &lt;?&gt; Daftar Siswa &lt;?&gt; &lt;/table&gt;`,
          slots: ["<caption>", "</caption>"],
          bank: ["<caption>", "</caption>", "<thead>", "</thead>"],
        },
        {
          instruksi: "Buat area teks multi-line di form.",
          preview: `&lt;form&gt; &lt;?&gt;Tulis di sini&lt;?&gt; &lt;/form&gt;`,
          slots: ["<textarea>", "</textarea>"],
          bank: ["<textarea>", "</textarea>", "<input>", "</input>"],
        },
        {
          instruksi: "Tambahkan select dropdown dengan opsi.",
          preview: `&lt;form&gt; &lt;?&gt; &lt;option&gt;A&lt;/option&gt; &lt;option&gt;B&lt;/option&gt; &lt;?&gt; &lt;/form&gt;`,
          slots: ["<select>", "</select>"],
          bank: ["<select>", "</select>", "<option>", "</option>"],
        },
      ];

      // ======= STATE =======
      let idx = 0;
      let answers = Array(QUIZ.length).fill(null);
      let done = Array(QUIZ.length).fill(false);
      const LS_KEY = "course:HTML:level2:progress";

      // restore progress
      const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      if (saved.idx !== undefined) idx = saved.idx;
      if (saved.answers) answers = saved.answers;
      if (saved.done) done = saved.done;

      // ======= RENDER =======
      const bar = document.getElementById("bar");
      const qTitle = document.getElementById("qTitle");
      const preview = document.getElementById("preview");
      const slotsWrap = document.getElementById("slots");
      const bankWrap = document.getElementById("bank");
      const feedback = document.getElementById("feedback");
      const pillWrap = document.getElementById("pillWrap");
      const badgeBox = document.getElementById("badgeBox");

      function render() {
        const q = QUIZ[idx];
        document.getElementById("instruksiBox").textContent = q.instruksi || "";

        qTitle.textContent = `Tantangan ${idx + 1}/${QUIZ.length}`;
        preview.innerHTML = q.preview.replaceAll(
          "&lt;?&gt;",
          "<span style='color:#22c55e'>[slot]</span>"
        );

        // progress bar
        const doneCount = done.filter(Boolean).length;
        bar.style.width = ((doneCount / QUIZ.length) * 100).toFixed(1) + "%";

        // pills
        pillWrap.innerHTML = "";
        for (let i = 0; i < QUIZ.length; i++) {
          const d = document.createElement("div");
          d.className =
            "pill" + (done[i] ? " done" : "") + (i === idx ? " active" : "");
          d.textContent = i + 1;
          pillWrap.appendChild(d);
        }

        // slots
        slotsWrap.innerHTML = "";
        const currentAns = answers[idx] || Array(q.slots.length).fill(null);
        for (let i = 0; i < q.slots.length; i++) {
          const s = document.createElement("div");
          s.className = "slot" + (currentAns[i] ? " filled" : "");
          s.dataset.slotIndex = i;
          s.ondragover = (e) => e.preventDefault();
          s.ondrop = (e) => {
            const tokenKey = e.dataTransfer.getData("text/plain");
            placeToken(i, tokenKey);
          };
          s.textContent = currentAns[i] || "drop here";
          slotsWrap.appendChild(s);
        }

        // bank
        bankWrap.innerHTML = "";
        let bankTokens = buildBankTokens(q, currentAns);

        // RANDOMIZE urutan bank
        bankTokens = [...bankTokens];
        for (let i = bankTokens.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [bankTokens[i], bankTokens[j]] = [bankTokens[j], bankTokens[i]];
        }

        bankTokens.forEach((tok, i) => {
          const uniqueKey = tok + "::" + i; // kasih ID unik
          const c = document.createElement("div");
          c.className = "chip";
          c.draggable = true;
          c.textContent = tok;
          c.ondragstart = (e) =>
            e.dataTransfer.setData("text/plain", uniqueKey);
          c.onclick = () => {
            const firstEmpty = (
              answers[idx] || Array(q.slots.length).fill(null)
            ).findIndex((v) => !v);
            if (firstEmpty > -1) placeToken(firstEmpty, uniqueKey);
          };
          bankWrap.appendChild(c);
        });

        // feedback
        feedback.className = "msg hidden";
        feedback.textContent = "";
        badgeBox.classList.toggle("hidden", !(doneCount === QUIZ.length));
      }

      function placeToken(slotIndex, tokenKey) {
        const [value] = tokenKey.split("::"); // ambil value murni
        const q = QUIZ[idx];
        let cur = answers[idx] || Array(q.slots.length).fill(null);

        cur[slotIndex] = value; // simpan hanya value murni
        answers[idx] = cur;
        save();
        render();
      }

      function buildBankTokens(q, currentAns) {
        // Hitung berapa kali tiap token muncul di slots
        const neededCounts = {};
        q.slots.forEach((tok) => {
          neededCounts[tok] = (neededCounts[tok] || 0) + 1;
        });

        // Hitung berapa kali token sudah dipakai
        const usedCounts = {};
        currentAns.forEach((tok) => {
          if (tok) {
            usedCounts[tok] = (usedCounts[tok] || 0) + 1;
          }
        });

        // Bikin ulang daftar bank
        const result = [];
        q.bank.forEach((tok) => {
          const used = usedCounts[tok] || 0;
          const needed = neededCounts[tok] || 0;

          // kalau masih ada sisa token yang boleh dipakai ‚Üí tampilkan
          if (used < needed) {
            result.push(tok);
            usedCounts[tok] = used + 1; // update sementara
          } else {
            result.push(tok); // tampilkan semua token di bank (opsional)
          }
        });

        return result;
      }

      function checkCurrent() {
        const q = QUIZ[idx];
        const cur = answers[idx] || Array(q.slots.length).fill(null);
        // semua harus terisi
        if (cur.some((v) => !v)) {
          showMsg("Isi semua slot dulu ya üîé", false, (soft = true));
          blinkEmpty();
          return;
        }
        // tandai benar/salah di slot
        const slots = [...document.querySelectorAll(".slot")];
        let allCorrect = true;
        for (let i = 0; i < q.slots.length; i++) {
          if (cur[i] === q.slots[i]) {
            slots[i].classList.add("correct");
            slots[i].classList.remove("wrong");
          } else {
            slots[i].classList.add("wrong");
            slots[i].classList.remove("correct");
            allCorrect = false;
          }
        }
        if (allCorrect) {
          done[idx] = true;
          showMsg("Mantap! Jawaban tepat ‚úÖ", true);
          save();
          // lanjut otomatis setelah sedikit jeda
          setTimeout(() => {
            if (idx < QUIZ.length - 1) {
              idx++;
              save();
              render();
            } else {
              render(); // <-- ini biar bar & pill update full
              onFinishLevel();
            }
          }, 700);
        } else {
          showMsg("Masih ada yang melenceng. Coba perbaiki ya ‚ùå", false);
        }
      }

      function blinkEmpty() {
        document.querySelectorAll(".slot").forEach((s) => {
          if (s.textContent === "drop here") {
            s.animate(
              [
                { transform: "scale(1)" },
                { transform: "scale(1.05)" },
                { transform: "scale(1)" },
              ],
              { duration: 300 }
            );
          }
        });
      }

      function resetCurrent() {
        const q = QUIZ[idx];
        answers[idx] = Array(q.slots.length).fill(null);
        document
          .querySelectorAll(".slot")
          .forEach((s) => s.classList.remove("correct", "wrong", "filled"));
        save();
        render();
      }

      function onFinishLevel() {
        // munculin popup
        document.getElementById("nextLevelPopup").style.display = "flex";

        // tombol next
        document.getElementById("nextBtn").onclick = () => {
          document.getElementById("nextLevelPopup").style.display = "none";
          // TODO: arahkan ke level berikutnya (misal redirect)
          window.location.href = "level3html.html";
        };
      }

      function showMsg(text, ok, soft = false) {
        feedback.textContent = text;
        feedback.className = "msg " + (ok ? "ok" : "err");
        if (soft) feedback.classList.add("soft");
        feedback.classList.remove("hidden");
      }

      function save() {
        localStorage.setItem(LS_KEY, JSON.stringify({ idx, answers, done }));
      }

      document.getElementById("resetBtn").addEventListener("click", () => {
        if (confirm("Yakin mau reset progress?")) {
          localStorage.removeItem(LS_KEY);
          location.reload();
        }
      });

      // ======= EVENTS =======
      document.getElementById("btnCheck").onclick = checkCurrent;
      document.getElementById("btnReset").onclick = resetCurrent;

      // first render
      render();

      // Animasi Bintang di Banner
      const canvas = document.getElementById("starsCanvas");
      const ctx = canvas.getContext("2d");

      let stars = [];
      const numStars = 100;

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }

      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      function createStars() {
        stars = [];
        for (let i = 0; i < numStars; i++) {
          stars.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            radius: Math.random() * 1.5,
            speed: Math.random() * 0.2 + 0.05,
          });
        }
      }

      function drawStars() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        stars.forEach((star) => {
          ctx.beginPath();
          ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
          ctx.fill();
        });
      }

      function updateStars() {
        stars.forEach((star) => {
          star.y += star.speed;
          if (star.y > canvas.height) {
            star.y = 0;
            star.x = Math.random() * canvas.width;
          }
        });
      }

      function animate() {
        drawStars();
        updateStars();
        requestAnimationFrame(animate);
      }

      createStars();
      animate();

      // Navbar dan Hamburger Menu
      const hamburger = document.getElementById("hamburger");
      const sideMenu = document.getElementById("sideMenu");
      const navbar = document.querySelector(".custom-navbar");

      function openMenu() {
        sideMenu.classList.add("active");
        hamburger.classList.add("open");
      }

      function closeMenu() {
        sideMenu.classList.remove("active");
        hamburger.classList.remove("open");

        // reset animasi biar pas buka lagi fresh
        sideMenu.querySelectorAll("a").forEach((link) => {
          link.style.animation = "none";
          setTimeout(() => (link.style.animation = ""), 10);
        });
      }

      // Toggle menu on click
      hamburger.addEventListener("click", () => {
        const isOpen = sideMenu.classList.toggle("active");
        hamburger.classList.toggle("open");

        if (!isOpen) {
          closeMenu();
        }
      });

      // Auto-close kalau kursor keluar area menu
      sideMenu.addEventListener("mouseleave", () => {
        closeMenu();
      });

      // Auto-open kalau kursor mentok kanan layar
      document.addEventListener("mousemove", (e) => {
        const edgeThreshold = 10; // jarak dari tepi kanan (px)
        if (window.innerWidth - e.clientX <= edgeThreshold) {
          openMenu();
        }
      });

      // Scroll effect: navbar jadi lebih gelwwap
      window.addEventListener("scroll", () => {
        if (window.scrollY > 50) {
          navbar.classList.add("scrolled");
        } else {
          navbar.classList.remove("scrolled");
        }
      });
    </script>
    <script src="../js/buttonback.js"></script>
  </body>
</html>
