<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Level 1 ‚Äì Game HTML: Tap/Drag Quiz</title>
    <link rel="stylesheet" href="../css/level1html.CSS" />
    <style>
      #pillWrap {
        display: flex;
        flex-wrap: nowrap;
        gap: 6px;
        overflow-x: auto;
        padding: 6px;
        max-width: 100%;
        scrollbar-width: thin;
        max-width: 330px;
        overflow-x: auto;
      }

      #pillWrap::-webkit-scrollbar {
        height: 6px;
      }
      #pillWrap::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 999px;
      }
      #pillWrap::-webkit-scrollbar-track {
        background: transparent;
      }

      .pill {
        flex: 0 0 auto;
        min-width: 40px;
        text-align: center;
      }
      .pill {
        display: inline-block;
        padding: 6px 10px;
        margin: 4px;
        border-radius: 6px;
        background: #e2e8f0;
        font-weight: bold;
        user-select: none;
      }
      .pill.done {
        background: #22c55e;
        color: white;
      }
      .pill.active {
        background: #3b82f6;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="custom-navbar fixed-top">
      <div class="navbar-container">
        <a href="../../index.php" class="logo"
          ><img src="../img/KiddosLogo.png" alt="Logo"
        /></a>
        <div class="nav-right">
          <div class="chatbot">
            <a href="Kiddos AI.html"
              ><img src="../img/boticons.png" alt="Chatbot"
            /></a>
          </div>
          <div class="hamburger" id="hamburger">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>
    </nav>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
      <a href="../../index.php"
        ><img src="../img/homeicons.png" class="menu-icon" />Home</a
      >
      <a href="../../index.php #Materi"
        ><img src="../img/brainicons.png" class="menu-icon2" />Learn</a
      >
      <a href="../../index.php #Games"
        ><img src="../img/gameicons.png" class="menu-icon3" />Games</a
      >
      <a href="profile.php"
        ><img src="../img/profileicons.png" class="menu-icon" />Profile</a
      >
    </div>

    <canvas id="starsCanvas"></canvas>
    <div class="page-wrapper">
      <div class="shell">
        <header>
          <h1>Game HTML: Tap/Drag Quiz</h1>
          <div class="sub">
            Tap/Drag & drop jawaban ke slot kosong. Selesaikan semua untuk dapat
            <b>Exp Melimpah</b>.
          </div>
          <div class="progress"><div id="bar" class="bar"></div></div>
          <button id="resetBtn" class="reset-btn">Reset Soal</button>
          <button
            id="btnPrev"
            class="ghost"
            style="
              position: relative;
              top: 2.8px;
              height: 2.25rem;
              margin-left: 5px;
            "
          >
            <span style="position: relative; top: -2px">‚¨ÖÔ∏è Kembali</span>
          </button>
        </header>

        <!-- LEFT: GAME -->
        <section class="card">
          <div id="qTitle" class="sub" style="font-weight: 700">
            Tantangan 1/8
          </div>

          <div
            id="instruksiBox"
            class="sub"
            style="font-weight: 600; color: white"
          ></div>

          <div class="prompt">
            <code id="preview">
              <!-- preview code akan dirender di sini -->
            </code>
          </div>

          <div class="slots" id="slots"></div>

          <div>
            <div
              style="
                font-weight: 700;
                margin-bottom: 6px;
                color: rgb(255, 255, 255);
              "
            >
              Bank Tag:
            </div>
            <div id="bank" class="bank"></div>
          </div>

          <div class="actions">
            <button id="btnCheck" class="primary">Cek Jawaban</button>
            <button id="btnReset" class="ghost">Reset Susunan</button>
            <span id="feedback" class="msg hidden"></span>
          </div>
        </section>

        <!-- RIGHT: SIDEBAR -->
        <aside class="side">
          <div class="stat">
            <h3>Progress Soal</h3>
            <div id="pillWrap" class="list"></div>
          </div>

          <div class="stat">
            <h3>Aturan Main</h3>
            <ul
              style="
                margin: 0.2rem 0 0.2rem 1rem;
                color: #334155;
                line-height: 1.6;
              "
            >
              <li>Tap/Drag jawaban ke slot kosong.</li>
              <li>Tekan <b>Cek Jawaban</b> untuk menilai.</li>
              <li>Benar = lanjut otomatis ke soal berikutnya.</li>
              <li>Selesaikan semua level untuk dapat exp melimpah.</li>
            </ul>
          </div>

          <div id="badgeBox" class="badge hidden">
            <div class="icon">‚≠ê</div>
            <div>
              <div style="font-weight: 800">Exp!</div>
              <div>Dapatkan 50 Exp/Soal, Semangattt!</div>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <script>
      const API = "/project_oscar_20/src/pages/level2_api.php";
      const MATERI = "html";

      document.addEventListener("DOMContentLoaded", () => {
        // ======= DATA SOAL (copy dari QUIZ kamu) =======
        const QUIZ = [
          {
            instruksi: "Kasih judul besar di atas teks.",
            preview: `&lt;?&gt; Hello World &lt;?&gt;`,
            slots: ["<h1>", "</h1>"],
            bank: ["<h1>", "</h1>", "<p>", "</p>"],
          },
          {
            instruksi: "Bungkus teks agar jadi paragraf.",
            preview: `&lt;?&gt;Belajar HTML itu seru!&lt;?&gt;`,
            slots: ["<p>", "</p>"],
            bank: ["<p>", "</p>", "<em>", "</em>"],
          },
          {
            instruksi: "Bikin teks jadi miring.",
            preview: `&lt;?&gt;Teks Miring&lt;?&gt;`,
            slots: ["<em>", "</em>"],
            bank: ["<em>", "</em>", "<strong>", "</strong>"],
          },
          {
            instruksi: "Buat teks jadi tebal.",
            preview: `&lt;?&gt;Teks Tebal&lt;?&gt;`,
            slots: ["<strong>", "</strong>"],
            bank: ["<strong>", "</strong>", "<small>", "</small>"],
          },
          {
            instruksi: "Bungkus daftar supaya jadi bullet list.",
            preview: `&lt;?&gt; Item 1&lt;br&gt; Item 2&lt;br&gt; Item 3`,
            slots: ["<ul>", "</ul>"],
            bank: ["<ul>", "</ul>", "<ol>", "</ol>"],
          },
          {
            instruksi: "Kasih judul halaman di tab browser.",
            preview: `&lt;?&gt;Belajar Web&lt;?&gt;`,
            slots: ["<title>", "</title>"],
            bank: ["<title>", "</title>", "<head>", "</head>"],
          },
          {
            instruksi: "Bikin teks jadi link ke Google.",
            preview: `&lt;?&gt;Link ke Google&lt;?&gt;`,
            slots: ['<a href="#">', "</a>"],
            bank: ['<a href="#">', "</a>", "<link>", "<button>"],
          },
          {
            instruksi: "Tambahkan gambar ke halaman.",
            preview: `&lt;? src="foto.jpg" alt="Saya"&gt;`,
            slots: ["<img", "/>"],
            bank: ["<img", "/>", "</img>", "<image>"],
          },
          {
            instruksi: "Buat baris tabel dengan data dua kolom.",
            preview: `&lt;table&gt; &lt;tr&gt; &lt;?&gt; Nama &lt;?&gt; &lt;?&gt; Umur &lt;?&gt;`,
            slots: ["<td>", "</td>", "<td>", "</td>"],
            bank: ["<td>", "</td>", "<td>", "</td>", "<th>", "</th>"],
          },
          {
            instruksi: "Kasih header tabel untuk judul kolom.",
            preview: `&lt;tr&gt; &lt;?&gt; Nama &lt;?&gt; &lt;?&gt; Umur &lt;?&gt;`,
            slots: ["<th>", "</th>", "<th>", "</th>"],
            bank: ["<th>", "</th>", "<td>", "</td>"],
          },
          {
            instruksi: "Bikin input teks dalam form.",
            preview: `&lt;form&gt; &lt;? type="text" name="user" ?&gt; &lt;/form&gt;`,
            slots: ["<input", ">"],
            bank: ["<input", ">", "<button>", "<textarea>"],
          },
          {
            instruksi: "Buat tombol submit di form.",
            preview: `&lt;form&gt; &lt;?&gt;Kirim&lt;?&gt; &lt;/form&gt;`,
            slots: ["<button type='submit'>", "</button>"],
            bank: ["<button type='submit'>", "</button>"],
          },
          {
            instruksi: "Bungkus item daftar terurut.",
            preview: `&lt;ol&gt; &lt;?&gt; Item 1 &lt;?&gt; &lt;?&gt; Item 2 &lt;?&gt; &lt;/ol&gt;`,
            slots: ["<li>", "</li>", "<li>", "</li>"],
            bank: ["<li>", "</li>", "<ul>", "</ul>"],
          },
          {
            instruksi: "Tambahkan caption pada tabel.",
            preview: `&lt;table&gt; &lt;?&gt; Daftar Siswa &lt;?&gt; &lt;/table&gt;`,
            slots: ["<caption>", "</caption>"],
            bank: ["<caption>", "</caption>", "<thead>", "</thead>"],
          },
          {
            instruksi: "Buat area teks multi-line di form.",
            preview: `&lt;form&gt; &lt;?&gt;Tulis di sini&lt;?&gt; &lt;/form&gt;`,
            slots: ["<textarea>", "</textarea>"],
            bank: ["<textarea>", "</textarea>", "<input>", "</input>"],
          },
          {
            instruksi: "Tambahkan select dropdown dengan opsi.",
            preview: `&lt;form&gt; &lt;?&gt; &lt;option&gt;A&lt;/option&gt; &lt;option&gt;B&lt;/option&gt; &lt;?&gt; &lt;/form&gt;`,
            slots: ["<select>", "</select>"],
            bank: ["<select>", "</select>", "<option>", "</option>"],
          },
          {
            instruksi: "Tambahkan gambar dengan sumber dan teks alternatif.",
            preview: `&lt;? src="foto.png" alt="Deskripsi"?&gt;`,
            slots: ["<img", ">"],
            bank: ["<img", ">", "<video>", "</video>"],
          },
          {
            instruksi: "Tambahkan audio dengan kontrol.",
            preview: `&lt;? controls&gt; &lt;source src="lagu.mp3" type="audio/mpeg"&gt; &lt;?&gt;`,
            slots: ["<audio", "</audio>"],
            bank: ["<audio", "</audio>", "<video", "</video>"],
          },
          {
            instruksi: "Tambahkan video dengan kontrol.",
            preview: `&lt;? controls&gt; &lt;source src="video.mp4" type="video/mp4"&gt; &lt;?&gt;`,
            slots: ["<video", "</video>"],
            bank: ["<video", "</video>", "<audio", "</audio>"],
          },
          {
            instruksi: "Buat hyperlink ke Google.",
            preview: `&lt;? href="https://google.com"?&gt;Google&lt;?&gt;`,
            slots: ["<a", "</a>"],
            bank: ["<a", "</a>", "<p>", "</p>"],
          },
          {
            instruksi: "Sematkan iframe YouTube.",
            preview: `&lt;? src="https://youtube.com/embed/abc123"?&gt;&lt;?&gt;`,
            slots: ["<iframe", "</iframe>"],
            bank: ["<iframe", "</iframe>", "<embed>", "</embed>"],
          },
          {
            instruksi: "Tambahkan gambar dengan lebar 300px.",
            preview: `&lt;img src="foto.png" alt="foto" ?="300"&gt;`,
            slots: ["width"],
            bank: ["width", "height", "src"],
          },
          {
            instruksi: "Tambahkan teks tebal dengan tag semantic.",
            preview: `&lt;?&gt;Teks Tebal&lt;?&gt;`,
            slots: ["<strong>", "</strong>"],
            bank: ["<strong>", "</strong>", "<b>", "</b>"],
          },
          {
            instruksi: "Tambahkan garis horizontal.",
            preview: `&lt;?&gt;`,
            slots: ["<hr>"],
            bank: ["<hr>", "<br>", "<p>"],
          },
          {
            instruksi: "Buat link absolute ke Google.",
            preview: `&lt;? href="https://google.com"?&gt;Google&lt;?&gt;`,
            slots: ["<a", "</a>"],
            bank: ["<a", "</a>", "<p>", "</p>"],
          },
          {
            instruksi: "Buat link relative ke file `about.html`.",
            preview: `&lt;? href="about.html"?&gt;Tentang Kami&lt;?&gt;`,
            slots: ["<a", "</a>"],
            bank: ["<a", "</a>", "<link>", "</link>"],
          },
          {
            instruksi: "Buat anchor link lompat ke bagian dengan id 'kontak'.",
            preview: `&lt;? href="#kontak"?&gt;Hubungi Kami&lt;?&gt;`,
            slots: ["<a", "</a>"],
            bank: ["<a", "</a>", "<div>", "</div>"],
          },
          {
            instruksi: "Buat link yang membuka halaman baru (tab baru).",
            preview: `&lt;a href="https://openai.com" ?="_blank"&gt;OpenAI&lt;/a&gt;`,
            slots: ["target"],
            bank: ["target", "href", "src"],
          },
          {
            instruksi: "Buat link email yang membuka aplikasi email.",
            preview: `&lt;? href="mailto:info@example.com"?&gt;Kirim Email&lt;?&gt;`,
            slots: ["<a", "</a>"],
            bank: ["<a", "</a>", "<mail>", "</mail>"],
          },
          {
            instruksi: "Buat link telepon yang bisa ditekan di HP.",
            preview: `&lt;? href="tel:+62123456789"?&gt;Hubungi Kami&lt;?&gt;`,
            slots: ["<a", "</a>"],
            bank: ["<a", "</a>", "<call>", "</call>"],
          },
          {
            instruksi: "Tambahkan link download untuk file `dokumen.pdf`.",
            preview: `&lt;a href="dokumen.pdf" ?&gt;Download PDF&lt;/a&gt;`,
            slots: ["download"],
            bank: ["download", "target", "src"],
          },
          {
            instruksi: "Buat link menuju bagian paling atas halaman.",
            preview: `&lt;? href="#top"?&gt;Kembali ke Atas&lt;?&gt;`,
            slots: ["<a", "</a>"],
            bank: ["<a", "</a>", "<up>", "</up>"],
          },
          {
            instruksi: "Gunakan tag untuk navigasi menu.",
            preview: "&lt;?&gt;Menu Website&lt;?&gt;",
            slots: ["<nav>", "</nav>"],
            bank: ["<nav>", "</nav>", "<div>", "</div>"],
          },
          {
            instruksi: "Buat header untuk judul halaman.",
            preview: "&lt;?&gt;Judul Utama&lt;?&gt;",
            slots: ["<header>", "</header>"],
            bank: ["<header>", "</header>", "<h1>", "</h1>"],
          },
          {
            instruksi: "Pilih tag yang tepat untuk isi artikel.",
            preview: "&lt;?&gt;Isi Artikel&lt;?&gt;",
            slots: ["<article>", "</article>"],
            bank: ["<article>", "</article>", "<section>", "</section>"],
          },
          {
            instruksi: "Gunakan section untuk kelompok konten.",
            preview: "&lt;?&gt;Tentang Kami&lt;?&gt;",
            slots: ["<section>", "</section>"],
            bank: ["<section>", "</section>", "<div>", "</div>"],
          },
          {
            instruksi: "Sidebar biasanya ditulis pakai tag apa?",
            preview: "&lt;?&gt;Link Tambahan&lt;?&gt;",
            slots: ["<aside>", "</aside>"],
            bank: ["<aside>", "</aside>", "<footer>", "</footer>"],
          },
          {
            instruksi: "Tambahkan bagian bawah halaman (footer).",
            preview: "&lt;?&gt;Hak Cipta 2025&lt;?&gt;",
            slots: ["<footer>", "</footer>"],
            bank: ["<footer>", "</footer>", "<div>", "</div>"],
          },
          {
            instruksi: "Kenapa lebih baik pakai semantic tag?",
            preview: "?",
            slots: ["Lebih jelas & mudah dibaca"],
            bank: [
              "Lebih jelas & mudah dibaca",
              "Biar keren aja",
              "Karena singkat",
            ],
          },
          {
            instruksi: "Pilih struktur halaman paling benar.",
            preview:
              "&lt;header&gt;...&lt;/header&gt; &lt;nav&gt;...&lt;/nav&gt; &lt;main&gt;...&lt;/main&gt; &lt;footer&gt;...&lt;/footer&gt;",
            slots: ["header", "nav", "main", "footer"],
            bank: ["header", "nav", "main", "footer", "div", "span"],
          },
        ];

        // ======= STATE =======
        let idx = 0;
        let answers = Array(QUIZ.length).fill(null);
        let done = Array(QUIZ.length).fill(false);

        // ======= UI ELEMENTS =======
        const bar = document.getElementById("bar");
        const qTitle = document.getElementById("qTitle");
        const preview = document.getElementById("preview");
        const slotsWrap = document.getElementById("slots");
        const bankWrap = document.getElementById("bank");
        const feedback = document.getElementById("feedback");
        const pillWrap = document.getElementById("pillWrap");
        const badgeBox = document.getElementById("badgeBox");
        const btnPrev = document.getElementById("btnPrev");

        // ======= LOAD PROGRESS FROM SERVER =======
        async function loadFromServer() {
          try {
            const resp = await fetch(
              API + `?action=get_progress&materi=${encodeURIComponent(MATERI)}`,
              { credentials: "same-origin" }
            );
            const data = await resp.json();
            if (data.success && data.progress) {
              const p = data.progress;
              if (p.idx !== undefined) idx = p.idx;
              if (Array.isArray(p.answers)) answers = p.answers;
              if (Array.isArray(p.done)) done = p.done;
            }
            render();
          } catch (err) {
            console.error("Gagal load progress:", err);
            render();
          }
        }

        // ======= SAVE PROGRESS TO SERVER =======
        async function saveToServer() {
          try {
            const body = new FormData();
            body.append("action", "save_progress");
            body.append("materi", MATERI);
            body.append("progress", JSON.stringify({ idx, answers, done }));
            const resp = await fetch(API, {
              method: "POST",
              body,
              credentials: "same-origin",
            });
            const data = await resp.json();
            if (!data.success) console.warn("save_progress failed:", data);
            return data;
          } catch (err) {
            console.error("save_progress exception", err);
            return { success: false, error: "network" };
          }
        }

        // ======= RENDER =======
        function render() {
          const q = QUIZ[idx];
          document.getElementById("instruksiBox").textContent =
            q.instruksi || "";
          qTitle.textContent = `Tantangan ${idx + 1}/${QUIZ.length}`;
          preview.innerHTML = q.preview.replaceAll(
            "&lt;?&gt;",
            "<span style='color:#22c55e'>[slot]</span>"
          );

          // progress bar
          const doneCount = done.filter(Boolean).length;
          bar.style.width = ((doneCount / QUIZ.length) * 100).toFixed(1) + "%";

          // pills
          pillWrap.innerHTML = "";
          for (let i = 0; i < QUIZ.length; i++) {
            const d = document.createElement("div");
            d.className =
              "pill" + (done[i] ? " done" : "") + (i === idx ? " active" : "");
            d.textContent = i + 1;
            d.onclick = () => {
              idx = i;
              saveToServer();
              render();
            };
            pillWrap.appendChild(d);
          }

          // slots
          slotsWrap.innerHTML = "";
          const currentAns = answers[idx] || Array(q.slots.length).fill(null);
          for (let i = 0; i < q.slots.length; i++) {
            const s = document.createElement("div");
            s.className = "slot" + (currentAns[i] ? " filled" : "");
            s.dataset.slotIndex = i;
            s.ondragover = (e) => e.preventDefault();
            s.ondrop = (e) => {
              const token = e.dataTransfer.getData("text/plain");
              placeToken(i, token);
            };
            s.textContent = currentAns[i] || "drop here";
            slotsWrap.appendChild(s);
          }

          // bank
          bankWrap.innerHTML = "";
          const bankTokens = buildBankTokens(q, currentAns);
          bankTokens.forEach((tok) => {
            const c = document.createElement("div");
            c.className = "chip";
            c.draggable = true;
            c.textContent = tok;
            c.ondragstart = (e) => e.dataTransfer.setData("text/plain", tok);
            c.onclick = () => {
              const firstEmpty = (
                answers[idx] || Array(q.slots.length).fill(null)
              ).findIndex((v) => !v);
              if (firstEmpty > -1) placeToken(firstEmpty, tok);
            };
            bankWrap.appendChild(c);
          });

          feedback.className = "msg hidden";
          feedback.textContent = "";
          badgeBox.classList.toggle("hidden", !(doneCount === QUIZ.length));
          updatePrevButtonState();
        }

        function buildBankTokens(q, currentAns) {
          const used = new Set(currentAns.filter(Boolean));
          return q.bank.filter((tok) => !used.has(tok));
        }

        function placeToken(slotIndex, token) {
          const q = QUIZ[idx];
          let cur = answers[idx] || Array(q.slots.length).fill(null);
          const alreadyAt = cur.findIndex((t) => t === token);
          if (alreadyAt > -1) cur[alreadyAt] = null;
          cur[slotIndex] = token;
          answers[idx] = cur;
          saveToServer().then(() => render());
        }

        function showMsg(text, ok, soft = false) {
          feedback.textContent = text;
          feedback.className = "msg " + (ok ? "ok" : "err");
          if (soft) feedback.classList.add("soft");
          feedback.classList.remove("hidden");
        }

        // Tambahkan fungsi awardExpForQuestion (copy dari file lain, misal level1py.html)
        async function awardExpForQuestion(index) {
          const awardKey = `${MATERI}_q${index}`;
          const fd = new FormData();
          fd.append("action", "grant_exp");
          fd.append("award_key", awardKey);
          fd.append("amount", "50");
          try {
            const resp = await fetch(API, {
              method: "POST",
              body: fd,
              credentials: "same-origin",
            });
            const ct = resp.headers.get("content-type") || "";
            if (!resp.ok) {
              console.warn("awardExp: server non-ok", resp.status);
              return;
            }
            if (ct.includes("application/json")) {
              const data = await resp.json();
              if (data.success && data.awarded) {
                showMsg(`+50 EXP! Mantap üî•`, true);
              }
            } else {
              console.warn("awardExp: unexpected content-type");
            }
          } catch (err) {
            console.error("awardExp exception", err);
          }
        }

        function checkCurrent() {
          const q = QUIZ[idx];
          const cur = answers[idx] || Array(q.slots.length).fill(null);
          if (cur.some((v) => !v)) {
            showMsg("Isi semua slot dulu ya üîé", false, true);
            blinkEmpty();
            return;
          }
          const slots = [...document.querySelectorAll(".slot")];
          let allCorrect = true;
          for (let i = 0; i < q.slots.length; i++) {
            if (cur[i] === q.slots[i]) {
              slots[i].classList.add("correct");
              slots[i].classList.remove("wrong");
            } else {
              slots[i].classList.add("wrong");
              slots[i].classList.remove("correct");
              allCorrect = false;
            }
          }
          if (allCorrect) {
            done[idx] = true;
            showMsg("Mantap! Jawaban tepat ‚úÖ", true);
            saveToServer().then(() => {
              awardExpForQuestion(idx); // <-- Tambahkan baris ini!
              setTimeout(() => {
                if (idx < QUIZ.length - 1) {
                  idx++;
                  saveToServer();
                  render();
                } else {
                  render();
                  onFinishLevel();
                }
              }, 700);
            });
          } else {
            showMsg("Masih ada yang melenceng. Coba perbaiki ya ‚ùå", false);
          }
        }

        function blinkEmpty() {
          document.querySelectorAll(".slot").forEach((s) => {
            if (s.textContent === "drop here") {
              s.animate(
                [
                  { transform: "scale(1)" },
                  { transform: "scale(1.05)" },
                  { transform: "scale(1)" },
                ],
                { duration: 300 }
              );
            }
          });
        }

        function resetCurrent() {
          const q = QUIZ[idx];
          answers[idx] = Array(q.slots.length).fill(null);
          document
            .querySelectorAll(".slot")
            .forEach((s) => s.classList.remove("correct", "wrong", "filled"));
          saveToServer().then(() => render());
        }

        function onFinishLevel() {
          document.getElementById("nextLevelPopup").style.display = "flex";
          document.getElementById("nextBtn").onclick = () => {
            document.getElementById("nextLevelPopup").style.display = "none";
            window.location.href = "level2html.html";
          };
        }

        function updatePrevButtonState() {
          if (!btnPrev) return;
          if (idx <= 0) {
            btnPrev.disabled = true;
            btnPrev.classList.add("disabled");
            btnPrev.title = "Tidak ada soal sebelumnya";
          } else {
            btnPrev.disabled = false;
            btnPrev.classList.remove("disabled");
            btnPrev.title = "Kembali ke soal sebelumnya";
          }
        }
        if (btnPrev)
          btnPrev.addEventListener("click", (e) => {
            e.preventDefault();
            if (idx > 0) {
              idx = Math.max(0, idx - 1);
              saveToServer().then(() => render());
              showMsg(`Kembali ke Tantangan ${idx + 1}`, true, true);
            }
          });

        document.getElementById("btnCheck").onclick = checkCurrent;
        document.getElementById("btnReset").onclick = resetCurrent;
        document.getElementById("resetBtn").addEventListener("click", () => {
          if (confirm("Yakin mau reset progress?")) {
            const params = new URLSearchParams({
              action: "save_progress",
              materi: MATERI,
              progress: JSON.stringify({
                idx: 0,
                answers: Array(QUIZ.length).fill(null),
                done: Array(QUIZ.length).fill(false),
              }),
            });
            fetch(API, {
              method: "POST",
              credentials: "same-origin",
              body: params,
            }).then(() => {
              idx = 0;
              answers = Array(QUIZ.length).fill(null);
              done = Array(QUIZ.length).fill(false);
              render();
            });
          }
        });
        // stars animation (same as before)
        const canvas = document.getElementById("starsCanvas");
        const ctx = canvas ? canvas.getContext("2d") : null;
        let stars = [];
        const numStars = 100;
        function resizeCanvas() {
          if (canvas) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
          }
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
        function createStars() {
          stars = [];
          for (let i = 0; i < numStars; i++)
            stars.push({
              x: Math.random() * canvas.width,
              y: Math.random() * canvas.height,
              radius: Math.random() * 1.5,
              speed: Math.random() * 0.2 + 0.05,
            });
        }
        function animateStars() {
          if (!ctx) return;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#fff";
          stars.forEach((star) => {
            ctx.beginPath();
            ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
            ctx.fill();
            star.y += star.speed;
            if (star.y > canvas.height) {
              star.y = 0;
              star.x = Math.random() * canvas.width;
            }
          });
          requestAnimationFrame(animateStars);
        }
        createStars();
        animateStars();

        // navbar behavior unchanged (omitted for brevity)
        const hamburger = document.getElementById("hamburger");
        const sideMenu = document.getElementById("sideMenu");
        const navbar = document.querySelector(".custom-navbar");
        function openMenu() {
          sideMenu.classList.add("active");
          hamburger.classList.add("open");
        }
        function closeMenu() {
          sideMenu.classList.remove("active");
          hamburger.classList.remove("open");
          sideMenu.querySelectorAll("a").forEach((link) => {
            link.style.animation = "none";
            setTimeout(() => (link.style.animation = ""), 10);
          });
        }
        if (hamburger)
          hamburger.addEventListener("click", () => {
            const isOpen = sideMenu.classList.toggle("active");
            hamburger.classList.toggle("open");
            if (!isOpen) closeMenu();
          });
        if (sideMenu) sideMenu.addEventListener("mouseleave", closeMenu);
        document.addEventListener("mousemove", (e) => {
          const edgeThreshold = 10;
          if (window.innerWidth - e.clientX <= edgeThreshold) openMenu();
        });
        window.addEventListener("scroll", () => {
          if (window.scrollY > 50) navbar.classList.add("scrolled");
          else navbar.classList.remove("scrolled");
        });

        // init: load server progress then render
        loadFromServer();
      });
    </script>
    <script src="../js/buttonback.js"></script>

    <!-- Overlay & Popup Next Level -->
    <div id="nextLevelPopup" class="popup-overlay" style="display: none">
      <div class="popup-card">
        <h2>üéâ Level Selesai!</h2>
        <p>Keren banget, kamu udah nyelesaiin semua soal di level ini.</p>
        <button id="nextBtn">‚û°Ô∏è Lanjut ke Level Berikutnya</button>
      </div>
    </div>
  </body>
</html>
